name: Upload to GitHub Releases

on:
    workflow_dispatch: {}
permissions:
    contents: write
jobs:
    upload-release:
        runs-on: [self-hosted, Windows]
        steps:
          - name: Load .env
            shell: powershell
            run: |
              Write-Host (Get-Location)
              $ENV_PATH = ".env"

              if (Test-Path -Path $ENV_PATH) {
                # .envファイルを1行ずつ読み込み、環境変数として設定
                Write-Host "Loading environment variables from $EnvFile"
                Get-Content -Path $ENV_PATH | ForEach-Object {
                  if ($_ -notlike "#*" -and $_ -notlike "") {
                    # KEY=value の形式を想定
                    if ($_ -match "^[A-Za-z_]+[A-Za-z0-9_]*=") {
                      $parts = $_.Split("=", 2)
                      $key = $parts[0]
                      $value = $parts[1]
                      # $env:GITHUB_ENV ファイルに追記して環境変数として設定
                      "'$key=$value'" | Out-File -Append -Encoding UTF8 -Path "$env:GITHUB_ENV"
                      Write-Host "Set environment variable: $key"
                    } else {
                      Write-Host "Skipping invalid line in .env file: $_"
                    }
                  }
                }
              } else {
                Write-Host "$ENV_PATH not found."
              }
          # Google Driveからファイルを取得
          - name: Create Zip
            shell: powershell
            run: |
              Compress-Archive -Path "$($env:DRIVE_PATH)" -DestinationPath "..\$($env:DRIVE_PATH)\Unity.zip"

          # GitHub Releasesへアップロード
          - name: Upload Releases
            if: failure() == false
            run: /
              gh release create ${{ github.ref_name }} ${{ secrets.DRIVE_PATH }}\Unity.zip --title "Release ${{ github.ref_name }}" --notes "このリリースはセルフホストランナーからアップロードされました。"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            # uses: ncipollo/release-action@v1
            # with:
            #   artifacts: file.zip
            #   token: ${{ secrets.GITHUB_TOKEN }}
            #   tag: ${{ github.ref_name }}
            #   name: Release ${{ github.ref_name }}
            #   body: |
            #     このリリースはセルフホストランナーからアップロードされました。
