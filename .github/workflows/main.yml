name: Upload to GitHub Releases

on:
    workflow_dispatch: {}
permissions:
    contents: write
jobs:
    upload-release:
        runs-on: [self-hosted, Windows]
        steps:
          - name: Load .env
            shell: powershell
            run: |
              Write-Host (Get-Location)
              $EnvFile = "sep.env"

              if (Test-Path -Path $EnvFile) {
                Write-Host "Loading environment variables from $EnvFile"
                # ファイルの内容を読み込み、改行で分割
                $lines = Get-Content -Path $EnvFile
                foreach ($line in $lines) {
                  if ($line -notlike "#*" -and $line -notlike "") {
                    if ($line -match "^[A-Za-z_]+[A-Za-z0-9_]*=") {
                      $parts = $line.Split("=", 2)
                      $key = $parts[0]
                      $value = $parts[1]
                      "'${key}=${value}'" | Out-File -Append -Encoding UTF8 -Path "$env:GITHUB_ENV"
                      Write-Host "Set environment variable for future steps: $key"
                    } else {
                      Write-Host "Skipping invalid line in .env file: $line"
                    }
                  }
                }
              } else {
                Write-Host "$EnvFile not found."
              }

          - name: Create Zip
            shell: powershell
            run: |
              Write-Host "DRIVE_PATH from env: $($env:DRIVE_PATH)" # デバッグ用
              if ($env:DRIVE_PATH) {
                Compress-Archive -Path "$($env:DRIVE_PATH)" -DestinationPath "..\$($env:DRIVE_PATH)\Unity.zip"
              } else {
                Write-Error "DRIVE_PATH environment variable is not set."
              }

          # GitHub Releasesへアップロード
          - name: Upload Releases
            if: failure() == false
            run: /
              gh release create ${{ github.ref_name }} ${{ secrets.DRIVE_PATH }}\Unity.zip --title "Release ${{ github.ref_name }}" --notes "このリリースはセルフホストランナーからアップロードされました。"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            # uses: ncipollo/release-action@v1
            # with:
            #   artifacts: file.zip
            #   token: ${{ secrets.GITHUB_TOKEN }}
            #   tag: ${{ github.ref_name }}
            #   name: Release ${{ github.ref_name }}
            #   body: |
            #     このリリースはセルフホストランナーからアップロードされました。
