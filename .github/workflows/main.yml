name: Upload to GitHub Releases

on:
  schedule:
    - cron: '0 0 * * *' # 毎日午前0時に実行
  workflow_dispatch: {}
permissions:
    contents: write
jobs:
    upload-release:
        runs-on: [self-hosted, Windows]
        env:
          DRIVE_PATH: I:\マイドライブ\September
        steps:
          - name: Intentionally fail on Windows
            shell: powershell
            run: |
              Write-Error "Intentional failure"
          - name: Checkout code
            uses: actions/checkout@v4
          - name: Create Zip
            shell: powershell
            run: |
              Write-Host "DRIVE_PATH from env: $env:DRIVE_PATH" # デバッグ用
              if ($env:DRIVE_PATH) {
                Compress-Archive -Force -Path "$env:DRIVE_PATH\Unity\*" -DestinationPath "$env:DRIVE_PATH\Unity.zip"
              } else {
                Write-Error "DRIVE_PATH environment variable is not set."
              }

          # GitHub Releasesへアップロード
          - name: Upload Releases
            if: failure() == false
            shell: powershell
            run: |
              $TIMESTAMP = Get-Date -Format "yyyyMMdd_HHmmss"
              Write-Host "TIMESTAMP from env: $TIMESTAMP" # デバッグ用
              gh release create $TIMESTAMP "$env:DRIVE_PATH\Unity.zip" --title "Release Unity Package" --notes "This is a release created from a self-hosted runner." --target main
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Discord Failure Post
            if: failure()
            run: |
              $url = "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}>"
              $message = "ZIP作成かGitHubReleasesへのアップロードかそれ以外の何かに失敗しました 要確認\n$url"
              $body = "{""content"":""$message""}"
              Invoke-WebRequest -Uri $webhookUrl `
                -Method Post `
                -Headers @{ "Content-Type" = "application/json" } `
                -Body $body
